# DO NOT EDIT THIS FILE! RATHER CREATE AN OVERRIDE COMPOSE FILE: https://docs.docker.com/compose/compose-file/13-merge/
version: "3.9"
services:
  negotiator:
    container_name: negotiator
    image: bbmrieric/negotiator:${BACKEND_TAG:-latest}
    ports:
      - '8081:8081'
    restart: always
    environment:
      - PROFILE=dev
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/negotiator
      - SPRING_DATASOURCE_USERNAME=negotiator
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD:-negotiator}
      - SPRING_DATASOURCE_INITIALIZE=false
      - SPRING_FLYWAY_ENABLED=true
      - SPRING_FLYWAY_USER=negotiator
      - SPRING_FLYWAY_PASSWORD=${DB_PASSWORD:-negotiator}
      - SPRING_FLYWAY_URL=jdbc:postgresql://postgres:5432/negotiator
      - NEGOTIATOR_FRONTENDURL=https://${HOST}
      - SERVER_FORWARD_HEADERS_STRATEGY=framework
      - NEGOTIATOR_AUTHORIZATION_CLAIM=eduperson_entitlement
      - "NEGOTIATOR_AUTHORIZATION_ADMINCLAIMVALUE=urn:geant:bbmri-eric.eu:res:role_admin#perun.bbmri-eric.eu"
      - "NEGOTIATOR_AUTHORIZATION_RESEARCHERCLAIMVALUE=urn:geant:bbmri-eric.eu:res:role_researcher#perun.bbmri-eric.eu"
      - "NEGOTIATOR_AUTHORIZATION_BIOBANKERCLAIMVALUE=urn:geant:bbmri-eric.eu:res:role_representative#perun.bbmri-eric.eu"
      - "NEGOTIATOR_AUTHORIZATION_RESOURCECLAIMPREFIX=urn:geant:bbmri-eric.eu:group:bbmri:collections:BBMRI-ERIC%20Directory:"
      - NEGOTIATOR_AUTHORIZATION_SUBJECTCLAIM=sub
      - SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_USERINFOURI=https://login.bbmri-eric.eu/oidc/userinfo
      - SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUERURI=https://login.bbmri-eric.eu/oidc/
      - SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWKSETURI=https://login.bbmri-eric.eu/oidc/jwk
      - SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_TYPE=at+jwt
      - SPRING_SECURITY_OAUTH2_RESOURCESERVER_OPAQUETOKEN_CLIENT_ID=${BACKEND_CLIENT_ID:-negotiator}
      - SPRING_SECURITY_OAUTH2_RESOURCESERVER_OPAQUETOKEN_CLIENT_SECRET=${BACKEND_CLIENT_SECRET:-negotiator}
      - SPRING_SECURITY_OAUTH2_RESOURCESERVER_OPAQUETOKEN_INTROSPECTION_URI=https://login.bbmri-eric.eu/oidc/introspect
      - SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_AUDIENCES=https://${HOST}
    volumes:
      - /var/log/negotiator:/var/log/negotiator
    depends_on:
      - postgres
  postgres:
    container_name: negotiator-db
    image: postgres:14
    restart: always
    environment:
      - POSTGRES_USER=negotiator
      - POSTGRES_PASSWORD=${DB_PASSWORD:-negotiator}
      - POSTGRES_DB=negotiator
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready", "-d", "negotiator" ]
      interval: 15s
      timeout: 60s
      retries: 5
    ports:
      - "127.0.0.1:5432:5432"
    command: -c 'shared_buffers=256MB' -c 'max_locks_per_transaction=1024'
